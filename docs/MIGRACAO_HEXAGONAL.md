# üèóÔ∏è Plano de Migra√ß√£o Hexagonal - B3DataManager

**Data de Cria√ß√£o:** 01/09/2025  
**√öltima Atualiza√ß√£o:** 01/09/2025  
**Status:** Em Planejamento  
**Arquiteto:** Claude 4 Sonnet  

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Estado Atual](#estado-atual)
3. [Achados de Auditoria](#achados-de-auditoria)
4. [Estrat√©gia de Migra√ß√£o](#estrat√©gia-de-migra√ß√£o)
5. [Cronograma Detalhado](#cronograma-detalhado)
6. [Configura√ß√µes Necess√°rias](#configura√ß√µes-necess√°rias)
7. [Checklist de Execu√ß√£o](#checklist-de-execu√ß√£o)
8. [Riscos e Mitiga√ß√µes](#riscos-e-mitiga√ß√µes)

---

## üéØ Vis√£o Geral

### **Objetivo Principal**
- Migrar de DDD para **Arquitetura Hexagonal pura**
- Separar **Domain** (regras de neg√≥cio) de **Infrastructure** (persist√™ncia)
- Resolver problemas de **performance** (c√°lculo de % em tempo real)
- Implementar **gest√£o de impostos** (DARF autom√°tica)
- Criar **sistema de an√°lise** de investimentos

### **Escopo da Migra√ß√£o**
- ‚úÖ **Operacao** - J√Å MIGRADA (hexagonal)
- ‚úÖ **Import** - J√Å MIGRADA (hexagonal)
- üîÑ **Portfolio + AtivoFinanceiro** - PRIORIDADE 1
- üîÑ **RendaVariavel + RendaFixa** - PRIORIDADE 2
- üîÑ **Transacao + Instituicao** - PRIORIDADE 3
- üîÑ **Sistema de Impostos** - PRIORIDADE 4

---

## üîÑ Controle de Vers√£o (GitHub)

### **üìã Estrat√©gia de Commits**

#### **üè∑Ô∏è Conven√ß√£o de Commits**
```
feat: adiciona nova funcionalidade
fix: corrige bug
refactor: refatora√ß√£o sem mudan√ßa de funcionalidade
test: adiciona ou modifica testes
docs: atualiza documenta√ß√£o
chore: tarefas de manuten√ß√£o
```

#### **üåø Estrat√©gia de Branches**
- **`main`** - C√≥digo est√°vel e funcional
- **`develop`** - Branch de desenvolvimento
- **`feature/hexagonal-migration`** - Branch principal da migra√ß√£o
- **`feature/portfolio-migration`** - Migra√ß√£o espec√≠fica do Portfolio
- **`feature/api-refactor`** - Refatora√ß√£o da API externa

#### **üì¶ Releases Incrementais**
- **v1.1.0** - Corre√ß√µes cr√≠ticas + Flyway
- **v1.2.0** - Portfolio + AtivoFinanceiro migrados
- **v1.3.0** - Nova API de pre√ßos
- **v1.4.0** - Sistema de impostos
- **v2.0.0** - Migra√ß√£o hexagonal completa

---

## üìä Estado Atual

### **‚úÖ M√≥dulos J√° Migrados (Hexagonal)**

#### **1. Operacao (Completa)**
- **Domain Model:** `domain.model.Operacao` (POJO puro)
- **Infrastructure:** `infrastructure.persistence.entity.OperacaoEntity` (JPA)
- **Use Cases:** `ListOperacoesUseCase`, `CountOperacoesUseCase`, `RegisterOperacaoUseCase`
- **Views:** `OperacaoView` (usando Use Cases)
- **Status:** ‚úÖ **COMPLETO E FUNCIONAL**

#### **2. Import (Completa)**
- **Use Cases:** `ProcessUploadUseCase`, `ImportExcelUseCase`, `GenerateErrorReportUseCase`
- **Views:** `ImportXlsxView` (Vaadin 24.8+)
- **Status:** ‚úÖ **COMPLETO E FUNCIONAL**

### **üîÑ M√≥dulos Pendentes (DDD Atual)**

#### **Entidades no domain.entity (9 entidades):**
- ‚ùå `AtivoFinanceiro` - **TEM VIEWS** (a√ß√µes + FII) - **PRIORIDADE 1**
- ‚ùå `RendaVariavel` - **TEM VIEWS** (a√ß√µes + FII) - **PRIORIDADE 1**
- ‚ùå `Portfolio` - **SEM VIEW** - **PRIORIDADE 1**
- ‚ùå `Transacao` - **SEM VIEW** - **PRIORIDADE 2**
- ‚ùå `RendaFixa` - **SEM VIEW** - **PRIORIDADE 2**
- ‚ùå `Instituicao` - **SEM VIEW** - **PRIORIDADE 3**
- ‚ùå `Usuario` - **TEM VIEW** (register/login) - **PRIORIDADE 3**
- ‚ùå `Renda` - **CLASSE BASE** - **PRIORIDADE 2**
- ‚ùå `Darf` - **SEM VIEW** - **PRIORIDADE 4**

#### **Views Existentes que Precisam Migrar:**
- üîÑ **A√ß√µes:** `GridwithFiltersAcoesView` + `FiltersAcoesView`
- üîÑ **FII:** `GridwithFiltersFiiView` + `FiltersFiiView`
- üîÑ **Usu√°rio:** `RegisterView` + `LoginView`

---

## üö® Achados de Auditoria

### **üìä Resumo Executivo**
- **Total de Achados:** 10
- **Cr√≠ticos:** 4 (40%)
- **Altos:** 4 (40%)
- **M√©dios:** 2 (20%)
- **Esfor√ßo Total:** 36.5 horas

### **üî¥ CR√çTICOS - A√ß√£o Imediata**

#### **1. SEC-001: Secrets em Plain-Text**
- **Arquivo:** `application.properties:6,35`
- **Evid√™ncia:** `spring.datasource.password=nB132MUlpZ4jxn7f`
- **Impacto:** Vazamento de credenciais
- **Corre√ß√£o:** ‚ö†Ô∏è **BAIXA PRIORIDADE** - Ser√° resolvido na dockeriza√ß√£o
- **Justificativa:** Banco de desenvolvimento, sem dados sens√≠veis
- **Esfor√ßo:** Ser√° feito com Docker Compose

#### **2. SEC-002: Frame Options Desabilitado**
- **Arquivo:** `SecurityConfig.java:44`
- **Evid√™ncia:** `frameOptions().disable()`
- **Impacto:** Vulnerabilidade a clickjacking
- **Corre√ß√£o:** Configurar SAMEORIGIN
- **Esfor√ßo:** 30 minutos

#### **3. OBS-001: Aus√™ncia de Actuator**
- **Arquivo:** `application.properties` (ausente)
- **Impacto:** Impossibilidade de monitoramento
- **Corre√ß√£o:** Habilitar Actuator com endpoints essenciais
- **Esfor√ßo:** 4 horas

#### **4. DATA-001: Aus√™ncia de Flyway**
- **Arquivo:** `pom.xml` (ausente)
- **Impacto:** Inconsist√™ncias de schema
- **Corre√ß√£o:** Implementar Flyway com baseline
- **Esfor√ßo:** 8 horas

### **üü† ALTOS - Corre√ß√£o Priorit√°ria**

#### **5. PERF-001: Eager Loading**
- **Arquivo:** `Usuario.java:40`
- **Evid√™ncia:** `@ElementCollection(fetch = FetchType.EAGER)`
- **Impacto:** Performance degradada
- **Corre√ß√£o:** Migrar para LAZY
- **Esfor√ßo:** 3 horas

#### **6. PERF-002: Open-in-View Habilitado**
- **Impacto:** Queries durante renderiza√ß√£o
- **Corre√ß√£o:** Desabilitar e implementar DTOs
- **Esfor√ßo:** 6 horas

#### **7. SEC-003: Aus√™ncia de Rate Limiting**
- **Impacto:** Vulnerabilidade a DoS
- **Corre√ß√£o:** Implementar com Resilience4j
- **Esfor√ßo:** 4 horas

#### **8. DEP-001: Depend√™ncias Desatualizadas**
- **Evid√™ncia:** `poi:5.3.0`, `mockito-inline:5.2.0`
- **Corre√ß√£o:** Atualizar vers√µes
- **Esfor√ßo:** 2 horas

---

## üîß Componentes a Normalizar (Hexagonal)

### **üìã Mapeamento Completo de N√£o-Conformidades**

#### **üî¥ Services que Violam Hexagonal**

##### **1. RendaVariavelService**
- **Localiza√ß√£o:** `application.service.RendaVariavelService`
- **Problema:** Service an√™mico com l√≥gica de dom√≠nio
- **Solu√ß√£o:** Migrar para Use Cases espec√≠ficos
- **Use Cases Necess√°rios:**
  - `ListAcoesUseCase`
  - `ListFiiUseCase`
  - `CalculatePerformanceUseCase`
  - `UpdateMarketPricesUseCase`

##### **2. AtivoFinanceiroService**
- **Localiza√ß√£o:** `application.service.AtivoFinanceiroService`
- **Problema:** CRUD gen√©rico sem regras de neg√≥cio
- **Solu√ß√£o:** Substituir por Use Cases espec√≠ficos
- **Use Cases Necess√°rios:**
  - `CreateAtivoUseCase`
  - `GetAtivoUseCase`
  - `UpdateAtivoUseCase`
  - `SearchAtivosUseCase`

##### **3. PortfolioService**
- **Localiza√ß√£o:** `application.service.PortfolioService`
- **Problema:** L√≥gica de c√°lculo no service
- **Solu√ß√£o:** Mover c√°lculos para Domain Model
- **Use Cases Necess√°rios:**
  - `GetPortfolioUseCase`
  - `CalculateDiversificationUseCase`
  - `RebalancePortfolioUseCase`

##### **4. TransacaoService**
- **Localiza√ß√£o:** `domain.service.TransacaoService`
- **Problema:** Service no domain (deveria ser Use Case)
- **Solu√ß√£o:** J√° parcialmente migrado para `CreateTransacaoUseCase`
- **Pendente:** Remover service ap√≥s migra√ß√£o completa

##### **5. InstituicaoService**
- **Localiza√ß√£o:** `application.service.InstituicaoService`
- **Problema:** CRUD simples sem valor agregado
- **Solu√ß√£o:** Use Cases espec√≠ficos
- **Use Cases Necess√°rios:**
  - `RegisterInstituicaoUseCase`
  - `ListInstituicoesUseCase`

#### **üü† Factories no Domain (Viola√ß√£o)**

##### **1. TransacaoFactory**
- **Localiza√ß√£o:** `domain.service.TransacaoFactory`
- **Problema:** Factory no domain com depend√™ncias de infrastructure
- **Solu√ß√£o:** Mover l√≥gica para Use Case ou Domain Service puro

##### **2. AtivoFactory**
- **Localiza√ß√£o:** `domain.service.AtivoFactory`
- **Problema:** Interface no domain, implementa√ß√£o com JPA
- **Solu√ß√£o:** Mover para application layer como Use Case

##### **3. RendaFactory**
- **Localiza√ß√£o:** `domain.service.RendaFactory`
- **Problema:** Factory com depend√™ncias de repositories
- **Solu√ß√£o:** Refatorar para Domain Service puro

#### **üü° Mappers Mal Posicionados**

##### **1. TipoMovimentacaoMapper**
- **Localiza√ß√£o:** `domain.service.TipoMovimentacaoMapper`
- **Problema:** Mapper no domain
- **Solu√ß√£o:** Mover para infrastructure ou application

##### **2. OperacaoMapper**
- **Localiza√ß√£o:** `infrastructure.mapper.OperacaoMapper`
- **Problema:** ‚úÖ **J√° est√° correto** (infrastructure)

#### **üîµ Batch Processing (N√£o-Hexagonal)**

##### **1. OperacaoItemProcessor**
- **Localiza√ß√£o:** `application.batch.processor.OperacaoItemProcessor`
- **Problema:** L√≥gica de neg√≥cio no processor
- **Solu√ß√£o:** Usar Use Cases dentro do processor

##### **2. BatchConfig**
- **Localiza√ß√£o:** `application.batch.config.BatchConfig`
- **Problema:** ‚úÖ **J√° corrigido** (usa Use Cases)

##### **3. CustomOperacaoItemReader**
- **Localiza√ß√£o:** `application.batch.reader.CustomOperacaoItemReader`
- **Problema:** Acesso direto a repository
- **Solu√ß√£o:** Usar Use Case para leitura

#### **üü£ Exception Handling**

##### **1. GlobalExceptionHandler**
- **Localiza√ß√£o:** `presentation.exception.GlobalExceptionHandler`
- **Problema:** ‚úÖ **J√° est√° correto** (presentation layer)

##### **2. Custom Exceptions**
- **Localiza√ß√£o:** `domain.exception.*`
- **Problema:** ‚úÖ **J√° est√£o corretas** (domain layer)

#### **‚ö´ API Externa (N√£o-Resiliente)**

##### **1. ApiMarketPriceClient**
- **Localiza√ß√£o:** `infrastructure.api.ApiMarketPriceClient`
- **Problema:** Depend√™ncia √∫nica do Yahoo Finance (inst√°vel)
- **Solu√ß√£o:** Interface com m√∫ltiplas implementa√ß√µes + Circuit Breaker

##### **2. MarketPrice Models**
- **Localiza√ß√£o:** `infrastructure.api.model.*`
- **Problema:** ‚úÖ **J√° est√£o corretos** (infrastructure)

### **üìä Resumo de Normaliza√ß√£o**

| Componente | Status Atual | A√ß√£o Necess√°ria | Prioridade |
|------------|--------------|-----------------|------------|
| RendaVariavelService | ‚ùå N√£o-conforme | Migrar para Use Cases | Alta |
| AtivoFinanceiroService | ‚ùå N√£o-conforme | Migrar para Use Cases | Alta |
| PortfolioService | ‚ùå N√£o-conforme | Migrar para Use Cases | Alta |
| TransacaoFactory | ‚ùå N√£o-conforme | Refatorar para Use Case | M√©dia |
| AtivoFactory | ‚ùå N√£o-conforme | Mover para Application | M√©dia |
| RendaFactory | ‚ùå N√£o-conforme | Domain Service puro | M√©dia |
| TipoMovimentacaoMapper | ‚ùå N√£o-conforme | Mover para Infrastructure | Baixa |
| OperacaoItemProcessor | ‚ùå N√£o-conforme | Usar Use Cases | Baixa |
| ApiMarketPriceClient | ‚ùå N√£o-resiliente | Interface + Circuit Breaker | Alta |
| TransacaoService | üîÑ Parcialmente migrado | Remover ap√≥s migra√ß√£o | Baixa |

### **üéØ Plano de Normaliza√ß√£o**

#### **Semana 11: Normaliza√ß√£o Final**
1. **Dia 46:** Migrar Services restantes para Use Cases
2. **Dia 47:** Refatorar Factories para Domain Services puros
3. **Dia 48:** Normalizar Batch Processing
4. **Dia 49:** Limpar depend√™ncias circulares
5. **Dia 50:** Valida√ß√£o final da arquitetura hexagonal

---

## üöÄ Estrat√©gia de Migra√ß√£o

### **üéØ Abordagem: Incremental Guiada por Views**

**Princ√≠pios:**
1. **Separa√ß√£o Clara:** Domain puro vs Infrastructure
2. **Migra√ß√£o Incremental:** Uma entidade por vez
3. **Compatibilidade:** Manter views funcionando durante migra√ß√£o
4. **Performance:** Resolver problema de % em tempo real
5. **Testes:** Cobertura completa em cada etapa

### **üìã Fases da Migra√ß√£o**

#### **ü•á FASE 1: Core de Gest√£o (2-3 semanas)**
**Entidades:** Portfolio + AtivoFinanceiro + RendaVariavel

**Por que come√ßar aqui:**
- ‚úÖ **2 Views existentes** (a√ß√µes + FII)
- ‚úÖ **Resolve performance** (% em tempo real ‚Üí coluna no banco)
- ‚úÖ **Base para tudo** (Portfolio √© agregado raiz)
- ‚úÖ **Alto valor** (core do sistema)

**Arquitetura Alvo:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     DOMAIN LAYER                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   Portfolio     ‚îÇ    ‚îÇ  AtivoFinanceiro                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ (Aggregate Root)‚îÇ    ‚îÇ  + PercentualCarteira (VO)     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ + TotalInvestido‚îÇ    ‚îÇ  + RendimentoAcumulado (VO)    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ + Diversificacao‚îÇ    ‚îÇ  + StatusInvestimento (VO)     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   APPLICATION LAYER                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇGetPortfolioUse  ‚îÇ    ‚îÇ  CalculatePortfolioUseCase      ‚îÇ ‚îÇ
‚îÇ  ‚îÇCase             ‚îÇ    ‚îÇ  (% carteira ‚Üí banco)           ‚îÇ ‚îÇ
‚îÇ  ‚îÇListAtivosUseCase‚îÇ    ‚îÇ  UpdatePercentualUseCase        ‚îÇ ‚îÇ
‚îÇ  ‚îÇAnalyzePortfolio ‚îÇ    ‚îÇ  (job ass√≠ncrono)               ‚îÇ ‚îÇ
‚îÇ  ‚îÇUseCase          ‚îÇ    ‚îÇ                                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 INFRASTRUCTURE LAYER                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇPortfolioEntity  ‚îÇ    ‚îÇ  AtivoFinanceiroEntity          ‚îÇ ‚îÇ
‚îÇ  ‚îÇRendaVariavelEnt ‚îÇ    ‚îÇ  + Repositories                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇity              ‚îÇ    ‚îÇ  + Mappers                      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **ü•à FASE 2: Gest√£o de Impostos (1-2 semanas)**
**Entidades:** Transacao + CalculoImposto + Darf

**Funcionalidades:**
- ‚úÖ **C√°lculo autom√°tico de DARF** (15% sobre lucro > R$ 20k/m√™s)
- ‚úÖ **Controle de preju√≠zos** (compensa√ß√£o)
- ‚úÖ **Alertas de vencimento** (√∫ltimo dia √∫til do m√™s)

#### **ü•â FASE 3: Refatora√ß√£o da API Externa (1 semana)**
**Objetivo:** Substituir Yahoo Finance por API confi√°vel

**Componentes:**
- ‚úÖ **Interface MarketDataProvider** (m√∫ltiplas fontes)
- ‚úÖ **BRAPI Implementation** (API brasileira gratuita)
- ‚úÖ **Scraping Fallback** (backup quando API falha)
- ‚úÖ **Circuit Breaker** (Resilience4j)
- ‚úÖ **Cache de pre√ßos** (Redis ou in-memory)

### **üèÖ FASE 4: Entidades de Apoio (1-2 semanas)**
**Entidades:** Instituicao + Usuario + RendaFixa

#### **üèÜ FASE 5: An√°lise Inteligente (2-3 semanas)**
**Funcionalidades:**
- ‚úÖ **An√°lise de timing** (compra/venda)
- ‚úÖ **Score de opera√ß√µes** (boas compras vs ruins)
- ‚úÖ **Rebalanceamento** (sugest√µes)

---

## üìÖ Cronograma Detalhado

### **üóìÔ∏è Semana 1-2: Prepara√ß√£o + Portfolio**

#### **Dia 1-2: Corre√ß√µes Cr√≠ticas de Seguran√ßa**
- [ ] **SEC-002:** Corrigir Frame Options (SAMEORIGIN)
- [ ] **OBS-001:** Configurar Actuator (health, metrics, info)
- [ ] **DATA-001:** Implementar Flyway com baseline
- [ ] **üîÑ Git:** Commit inicial das corre√ß√µes cr√≠ticas

#### **Dia 3-5: Domain Models Puros**
- [ ] Criar `domain.model.Portfolio` (POJO puro)
- [ ] Criar `domain.model.AtivoFinanceiro` (POJO puro)
- [ ] Criar Value Objects:
  - [ ] `PercentualCarteira`
  - [ ] `ValorInvestido`
  - [ ] `RendimentoTotal`
  - [ ] `Ticker`

#### **Dia 6-7: Infrastructure Entities**
- [ ] Mover `domain.entity.*` ‚Üí `infrastructure.persistence.entity.*`
- [ ] Criar `PortfolioEntity` (JPA)
- [ ] Criar `AtivoFinanceiroEntity` (JPA + coluna `percentual_carteira`)
- [ ] Adicionar migra√ß√£o Flyway para nova coluna

#### **Dia 8-10: Use Cases + Ports**
- [ ] Criar interfaces de ports:
  - [ ] `PortfolioRepository`
  - [ ] `AtivoFinanceiroRepository`
  - [ ] `MarketDataService`
- [ ] Implementar Use Cases:
  - [ ] `GetPortfolioUseCase`
  - [ ] `ListAtivosUseCase`
  - [ ] `CalculatePortfolioPercentagesUseCase`

### **üóìÔ∏è Semana 3: Adapters + Views**

#### **Dia 11-12: Repository Adapters**
- [ ] Implementar `PortfolioRepositoryAdapter`
- [ ] Implementar `AtivoFinanceiroRepositoryAdapter`
- [ ] Criar Mappers (Domain ‚Üî Entity)

#### **Dia 13-14: Job Ass√≠ncrono**
- [ ] Implementar `UpdatePortfolioPercentagesUseCase`
- [ ] Configurar `@Scheduled` (5 minutos)
- [ ] Testar performance de c√°lculo

#### **Dia 15: Migra√ß√£o das Views**
- [ ] Atualizar `GridwithFiltersAcoesView`
- [ ] Atualizar `GridwithFiltersFiiView`
- [ ] Remover c√°lculos em tempo real
- [ ] Usar percentuais pr√©-calculados

### **üóìÔ∏è Semana 4: RendaVariavel + Git**

#### **Dia 16-18: RendaVariavel**
- [ ] Criar `domain.model.RendaVariavel`
- [ ] Migrar `RendaVariavelEntity`
- [ ] Implementar Use Cases espec√≠ficos
- [ ] Integrar com Portfolio
- [ ] **üîÑ Git:** Commit da migra√ß√£o RendaVariavel

#### **Dia 19-21: Testes + Documenta√ß√£o**
- [ ] Testes unit√°rios (Domain)
- [ ] Testes de integra√ß√£o (Use Cases)
- [ ] Testes de regress√£o (Views)
- [ ] Atualizar documenta√ß√£o
- [ ] **üîÑ Git:** Commit dos testes

### **üóìÔ∏è Semana 5: Nova API de Pre√ßos**

#### **Dia 22-24: Refatora√ß√£o da API**
- [ ] Interface `MarketDataProvider`
- [ ] Implementa√ß√£o BRAPI (https://brapi.dev/)
- [ ] Scraping fallback para B3
- [ ] Circuit Breaker com Resilience4j
- [ ] **üîÑ Git:** Commit da nova API

#### **Dia 25-26: Cache e Performance**
- [ ] `UpdateMarketPricesUseCase`
- [ ] Cache de pre√ßos (TTL 5 minutos)
- [ ] Substituir Yahoo Finance completamente
- [ ] Testes de carga da API
- [ ] **üîÑ Git:** Commit do sistema de cache

### **üóìÔ∏è Semana 6-7: Sistema de Impostos**

#### **Dia 26-28: Domain de Impostos**
- [ ] Criar `domain.model.CalculoImposto`
- [ ] Criar `domain.model.Darf`
- [ ] Value Objects para impostos

#### **Dia 29-32: Use Cases de Impostos**
- [ ] `CalculateDarfUseCase`
- [ ] `GetTaxObligationsUseCase`
- [ ] `CompensatePrejuizosUseCase`

#### **Dia 33-35: View de Impostos**
- [ ] Criar `ImpostosView`
- [ ] Dashboard de obriga√ß√µes
- [ ] Alertas de vencimento

### **üóìÔ∏è Semana 8-10: An√°lise Inteligente + Normaliza√ß√£o Final**

#### **Dia 36-40: Sistema de An√°lise**
- [ ] `AnalyzeOperationPerformanceUseCase`
- [ ] `GetBuySignalsUseCase`
- [ ] `GetSellSignalsUseCase`
- [ ] Algoritmos de an√°lise t√©cnica

#### **Dia 41-45: View de An√°lise**
- [ ] Criar `AnaliseView`
- [ ] Gr√°ficos de performance
- [ ] Recomenda√ß√µes de compra/venda
- [ ] Score de opera√ß√µes
- [ ] **üîÑ Git:** Commit do sistema de an√°lise

### **üóìÔ∏è Semana 11: Normaliza√ß√£o Hexagonal Final**

#### **Dia 46-50: Componentes Restantes**
- [ ] Migrar Services restantes para Use Cases
- [ ] Normalizar Exception Handling
- [ ] Refatorar Batch Processing
- [ ] Limpar depend√™ncias circulares
- [ ] **üîÑ Git:** Commit final da normaliza√ß√£o

---

## ‚öôÔ∏è Configura√ß√µes Necess√°rias

### **üîß Flyway Setup**

#### **1. Depend√™ncias (pom.xml)**
```xml
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-mysql</artifactId>
</dependency>
```

#### **2. Configura√ß√£o (application.properties)**
```properties
# Flyway
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=1
spring.flyway.locations=classpath:db/migration
spring.flyway.validate-on-migrate=true
spring.flyway.clean-disabled=true

# Hibernate
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.open-in-view=false
```

#### **3. Estrutura de Diret√≥rios**
```
src/main/resources/
‚îî‚îÄ‚îÄ db/
    ‚îî‚îÄ‚îÄ migration/
        ‚îú‚îÄ‚îÄ V1__baseline.sql
        ‚îú‚îÄ‚îÄ V2__add_percentual_carteira_column.sql
        ‚îî‚îÄ‚îÄ V3__create_impostos_tables.sql
```

### **üîí Seguran√ßa**

#### **1. Externalizar Secrets**
```bash
# Vari√°veis de ambiente
export DB_PASSWORD=nB132MUlpZ4jxn7f
export API_ALPHA_KEY=BRRQ6MQO8CYYPM5M
```

```properties
# application.properties
spring.datasource.password=${DB_PASSWORD}
api.alpha.key=${API_ALPHA_KEY}
```

#### **2. Configurar Frame Options**
```java
// SecurityConfig.java
.headers(headers -> headers
    .frameOptions(HeadersConfigurer.FrameOptionsConfig::sameOrigin)
)
```

### **üìä Observabilidade**

#### **1. Actuator**
```properties
# Endpoints essenciais
management.endpoints.web.exposure.include=health,metrics,info
management.endpoint.health.show-details=when-authorized
management.metrics.export.prometheus.enabled=true
```

### **‚ö° Performance**

#### **1. JPA Otimizado**
```properties
# Desabilitar Open-in-View
spring.jpa.open-in-view=false

# Otimiza√ß√µes de performance
spring.jpa.properties.hibernate.jdbc.batch_size=25
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
```

#### **2. Lazy Loading**
```java
// Corrigir eager loading
@ElementCollection(fetch = FetchType.LAZY)
private Set<String> instituicoes;
```

---

## ‚úÖ Checklist de Execu√ß√£o

### **üî¥ Pr√©-Requisitos (Cr√≠ticos)**
- [ ] **Backup completo** do banco de dados
- [ ] **Ambiente de teste** id√™ntico √† produ√ß√£o
- [ ] **Vari√°veis de ambiente** configuradas
- [ ] **Flyway baseline** executado com sucesso
- [ ] **Testes de regress√£o** passando

### **üìã Fase 1: Portfolio + AtivoFinanceiro**

#### **Domain Layer**
- [ ] `domain.model.Portfolio` criado
- [ ] `domain.model.AtivoFinanceiro` criado
- [ ] Value Objects criados:
  - [ ] `PercentualCarteira`
  - [ ] `ValorInvestido`
  - [ ] `RendimentoTotal`
  - [ ] `Ticker`
- [ ] Invariantes implementados
- [ ] Testes unit√°rios (100% cobertura)

#### **Application Layer**
- [ ] Ports definidos:
  - [ ] `PortfolioRepository`
  - [ ] `AtivoFinanceiroRepository`
  - [ ] `MarketDataService`
- [ ] Use Cases implementados:
  - [ ] `GetPortfolioUseCase`
  - [ ] `ListAtivosUseCase`
  - [ ] `CalculatePortfolioPercentagesUseCase`
- [ ] Commands e Results criados
- [ ] Testes de Use Cases (100% cobertura)

#### **Infrastructure Layer**
- [ ] Entities movidas para `infrastructure.persistence.entity`:
  - [ ] `PortfolioEntity`
  - [ ] `AtivoFinanceiroEntity`
- [ ] Coluna `percentual_carteira` adicionada
- [ ] Repository Adapters implementados
- [ ] Mappers criados (Domain ‚Üî Entity)
- [ ] Testes de integra√ß√£o

#### **Presentation Layer**
- [ ] Views atualizadas:
  - [ ] `GridwithFiltersAcoesView`
  - [ ] `GridwithFiltersFiiView`
- [ ] C√°lculos em tempo real removidos
- [ ] Percentuais pr√©-calculados utilizados
- [ ] Testes de UI

#### **Jobs Ass√≠ncronos**
- [ ] `UpdatePortfolioPercentagesUseCase` implementado
- [ ] `@Scheduled` configurado (5 minutos)
- [ ] Logs de monitoramento
- [ ] Tratamento de erros robusto

### **üìã Fase 2: Sistema de Impostos**
- [ ] `domain.model.CalculoImposto` criado
- [ ] `domain.model.Darf` criado
- [ ] Use Cases de impostos implementados
- [ ] `ImpostosView` criada
- [ ] Alertas de vencimento funcionando

### **üìã Fase 3: An√°lise Inteligente**
- [ ] Algoritmos de an√°lise implementados
- [ ] `AnaliseView` criada
- [ ] Score de opera√ß√µes funcionando
- [ ] Recomenda√ß√µes de compra/venda

### **üß™ Testes e Qualidade**
- [ ] **Cobertura de testes:** > 90%
- [ ] **Testes de performance:** < 100ms por consulta
- [ ] **Testes de carga:** 1000 req/min
- [ ] **Testes de seguran√ßa:** Sem vulnerabilidades
- [ ] **Testes de regress√£o:** Todas as funcionalidades

### **üöÄ Deploy e Monitoramento**
- [ ] **Deploy em staging:** Sucesso
- [ ] **Testes de aceita√ß√£o:** Aprovados
- [ ] **Monitoramento:** M√©tricas coletadas
- [ ] **Logs:** Estruturados e funcionais
- [ ] **Backup:** Estrat√©gia de rollback testada

---

## ‚ö†Ô∏è Riscos e Mitiga√ß√µes

### **üî¥ Riscos Cr√≠ticos**

#### **1. Perda de Dados Durante Migra√ß√£o**
- **Probabilidade:** Baixa
- **Impacto:** Cr√≠tico
- **Mitiga√ß√£o:**
  - ‚úÖ Backup completo antes de cada etapa
  - ‚úÖ Testes em ambiente id√™ntico
  - ‚úÖ Rollback autom√°tico em caso de falha
  - ‚úÖ Valida√ß√£o de integridade p√≥s-migra√ß√£o

#### **2. Performance Degradada**
- **Probabilidade:** M√©dia
- **Impacto:** Alto
- **Mitiga√ß√£o:**
  - ‚úÖ Testes de performance em cada etapa
  - ‚úÖ Monitoramento em tempo real
  - ‚úÖ Otimiza√ß√£o de queries e √≠ndices
  - ‚úÖ Cache estrat√©gico

#### **3. Incompatibilidade de Views**
- **Probabilidade:** M√©dia
- **Impacto:** Alto
- **Mitiga√ß√£o:**
  - ‚úÖ Migra√ß√£o incremental
  - ‚úÖ Testes de regress√£o automatizados
  - ‚úÖ Manuten√ß√£o de contratos de API
  - ‚úÖ Feature flags para rollback

### **üü† Riscos Moderados**

#### **4. Complexidade de Mapeamento**
- **Probabilidade:** Alta
- **Impacto:** M√©dio
- **Mitiga√ß√£o:**
  - ‚úÖ Mappers bem testados
  - ‚úÖ Valida√ß√£o de dados
  - ‚úÖ Logs detalhados
  - ‚úÖ Testes de convers√£o

#### **5. Prazo de Entrega**
- **Probabilidade:** M√©dia
- **Impacto:** M√©dio
- **Mitiga√ß√£o:**
  - ‚úÖ Cronograma realista
  - ‚úÖ Entregas incrementais
  - ‚úÖ Prioriza√ß√£o por valor
  - ‚úÖ Buffer de tempo

### **üü° Riscos Baixos**

#### **6. Resist√™ncia √† Mudan√ßa**
- **Probabilidade:** Baixa
- **Impacto:** Baixo
- **Mitiga√ß√£o:**
  - ‚úÖ Documenta√ß√£o clara
  - ‚úÖ Treinamento da equipe
  - ‚úÖ Benef√≠cios vis√≠veis
  - ‚úÖ Suporte cont√≠nuo

---

## üìä M√©tricas de Sucesso

### **üéØ KPIs T√©cnicos**
- **Performance:** Tempo de carregamento < 100ms
- **Disponibilidade:** > 99.9%
- **Cobertura de Testes:** > 90%
- **Bugs em Produ√ß√£o:** < 1 por semana
- **Tempo de Build:** < 5 minutos

### **üí∞ KPIs de Neg√≥cio**
- **C√°lculo de DARF:** Autom√°tico e preciso
- **An√°lise de Performance:** Insights acion√°veis
- **Gest√£o de Carteira:** Rebalanceamento eficiente
- **Satisfa√ß√£o do Usu√°rio:** > 4.5/5
- **Tempo de Processamento:** Import < 30 segundos

### **üîí KPIs de Seguran√ßa**
- **Vulnerabilidades:** Zero cr√≠ticas
- **Secrets Expostos:** Zero
- **Rate Limiting:** Funcionando
- **Monitoramento:** 100% cobertura
- **Backup:** Testado semanalmente

---

## üìö Refer√™ncias

### **Documenta√ß√£o T√©cnica**
- [Arquitetura Hexagonal](https://alistair.cockburn.us/hexagonal-architecture/)
- [Domain-Driven Design](https://martinfowler.com/bliki/DomainDrivenDesign.html)
- [Spring Boot Best Practices](https://spring.io/guides)
- [Flyway Documentation](https://flywaydb.org/documentation/)

### **Documenta√ß√£o do Projeto**
- [Funcionalidades de Importa√ß√£o](funcionalidades/import.md)
- [Funcionalidades de Opera√ß√£o](funcionalidades/operacao.md)
- [Configura√ß√£o do Flyway](flyway/README-flyway-setup.md)

### **Ferramentas e Tecnologias**
- **Spring Boot 3.5.5**
- **Java 21**
- **Vaadin 24.8+**
- **MySQL/MariaDB**
- **Flyway**
- **JUnit 5**
- **Mockito**

---

## üìù Log de Altera√ß√µes

| Data | Vers√£o | Altera√ß√£o | Autor |
|------|--------|-----------|-------|
| 01/09/2025 | 1.0 | Cria√ß√£o inicial do plano | Claude 4 Sonnet |
| | | Consolida√ß√£o de achados de auditoria | |
| | | Defini√ß√£o de cronograma detalhado | |
| | | Estrat√©gia de migra√ß√£o hexagonal | |

---

**üéØ Pr√≥ximo Passo:** Executar corre√ß√µes cr√≠ticas de seguran√ßa (Dia 1-2)

**üìû Contato:** Para d√∫vidas ou ajustes no plano, consulte a documenta√ß√£o ou abra uma issue.

---

*Este documento √© um guia vivo e ser√° atualizado conforme o progresso da migra√ß√£o.*